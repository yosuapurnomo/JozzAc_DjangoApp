{% extends "admin/base_admin.html" %}

{% block Content %}
	<div class="container-fluid">
		<div class=" d-sm-flex align-items-center justify-content-between mb-4">
        	<h1 class="h3 mb-0 text-gray-800">INVOICE</h1>
    	</div>

	    <div class="form-inline">
	    	<div class="form-group">
		    	<input type="text" list="invoiceList" class="form-control" id='input_Inv' placeholder="No Invoice" />
		    		<datalist id="invoiceList">
						{% for data in listInvoice %}
							<option>{{data.Invoice}}</option>
						{% endfor %}
					</datalist>
		    	<button type="submit" class="btn btn-primary ml-3" onclick="search(input_Inv.value)">Search</button>
	    	</div>
	    </div>
    <hr>

    	<div id='invoiceFalse' style="display:none">
    		<h1 id="invoiceInfo">
    			
    		</h1>
    	</div>
    
	    <div id='invoiceView' style="display:none">
	    	<div class="card border-success mb-3" style="max-width: 40%;">
			  <div class="card-header bg-transparent border-success font-weight-bold" id='invoice'></div>
			  <div class="card-body text-dark">
			    <h5 class="card-title" id='clientINV'></h5>
			    <p class="card-text" id='Keterangan'></p>
			    <p class="card-text" id='totalInvoice'></p>
			    <p class="card-text" id='statusPembayaran'></p>
			  </div>
			  <div class="card-footer bg-transparent border-success">
			  	<a class="btn btn-primary" id='link_Edit'>Detail</a>
			  	<a class="btn btn-success" id='link_Cetak' target="_blank">Cetak</a>
			  </div>
			</div>	
	    </div>

	</div>
	
{% endblock Content %}

{% block javaScript %}
	<script type="text/javascript">
		var loc = window.location
		var wsStart = 'ws://';
		if (loc.protocol == 'https:') {
			wsStart = 'ws://'
		}
		
		url = wsStart + loc.host + loc.pathname;

		function search(value){
			if (value != '-' ) {
				key = value.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,'_')
				var socket = new WebSocket(url+key);
			
				socket.onmessage = function(e){
					console.log('Message : ', e);
					var data = JSON.parse(e.data)
					if (data.invoice !== false) {
						console.log("Tidak False")
						var x = document.getElementById('invoiceView')
						var y = document.getElementById('invoiceFalse')
						if (x.style.display === 'none') {
							x.style.display = 'block';
						}
						if (y.style.display === 'block') {
							y.style.display = 'none';
						}
						var total = data.totalInvoice;
						
						document.getElementById("invoice").innerHTML = data.invoice;
						document.getElementById("totalInvoice").innerHTML = "Total : Rp." + total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
						document.getElementById("clientINV").innerHTML = "Nama Client : " + data.clientINV;
						ket = data.Keterangan;


						document.getElementById("Keterangan").innerHTML = "Keterangan : " + ket.replace(/\r?\n/g, '<br />');
						document.getElementById("statusPembayaran").innerHTML = "Status Pembayaran : " + data.statusPembayaran;
						let link_Edit = document.getElementById("link_Edit").setAttribute('href', "{% url "pesanan:invoiceUpdate" slug='slugInvoice' %}".replace(/slugInvoice/, data.slug));
						let link_Cetak = document.getElementById("link_Cetak").setAttribute('href', "{% url "pesanan:createPDF" slug='slugInvoice' %}".replace(/slugInvoice/, data.slug));
					}
					else {
						console.log("False")
						var x = document.getElementById('invoiceView')
						var y = document.getElementById('invoiceFalse')

						if (x.style.display === 'block') {
							x.style.display = 'none';
						}
						if (y.style.display == 'none') {
							y.style.display = 'block';
						}
						
						document.getElementById("invoiceInfo").innerHTML = "Invoice Tidak Ada";
					}
				}

				socket.onopen = function(e){
					console.log('open', e);
				};

				socket.onerror = function(e){
					console.log('error', e);
				};

				socket.onclose = function(e){
					console.log('close', e);
				};
			}
		}

	</script>
{% endblock javaScript %}